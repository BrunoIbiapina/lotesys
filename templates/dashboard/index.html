{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% load ui %}
{% block content %}

<div class="flex items-center justify-between mb-4">
  <h1 class="text-3xl font-semibold">Dashboard</h1>
  <a href="/financeiro/extrato/"
     class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">
     üìä Ver Extrato Detalhado
  </a>
</div>

<form method="get" class="bg-white p-4 rounded-xl shadow mb-6">
  <div class="grid sm:grid-cols-4 gap-4 items-end">
    <div>
      <label class="text-sm text-gray-600">In√≠cio</label>
      <input type="date" name="inicio" value="{{ inicio|date:'Y-m-d' }}" class="w-full border rounded p-2">
    </div>
    <div>
      <label class="text-sm text-gray-600">Fim</label>
      <input type="date" name="fim" value="{{ fim|date:'Y-m-d' }}" class="w-full border rounded p-2">
    </div>
    <div class="sm:col-span-2">
      <button class="px-4 py-2 rounded bg-gray-900 text-white">Aplicar filtros</button>
      <a href="?" class="ml-2 text-sm underline">Limpar</a>
    </div>
  </div>
</form>

{# ===================== RESUMO DE HOJE ===================== #}
<div class="grid md:grid-cols-3 gap-4 mb-6">
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Entradas HOJE</div>
    <div class="text-2xl font-bold text-emerald-700">{{ entradas_hoje|brl }}</div>
    <div class="text-xs text-gray-500 mt-1">Parcelas pagas hoje + entradas l√≠quidas de vendas de hoje</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Despesas PAGAS HOJE</div>
    <div class="text-2xl font-bold text-red-600">{{ despesas_hoje|brl }}</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Fluxo L√≠quido HOJE</div>
    <div class="text-2xl font-bold text-blue-700">{{ fluxo_hoje|brl }}</div>
  </div>
</div>

{# ===================== ALERTAS (Vencidas / Hoje / Pr√≥x. 7 dias) ===================== #}
{% if vencidas_qtd or vencem_hoje_count or prox7_qtd %}
<div class="grid md:grid-cols-3 gap-4 mb-6">

  {# ---- VENCIDAS ---- #}
  {% if vencidas_qtd %}
  <div class="bg-red-50 border border-red-200 text-red-800 p-4 rounded-2xl">
    <div class="flex items-center justify-between">
      <div>
        <div class="font-semibold">‚ö†Ô∏è Parcelas vencidas</div>
        <div class="text-sm text-red-700 mt-1">
          {{ vencidas_qtd }} parcela(s) em atraso ‚Äî total {{ vencidas_valor|brl }}
        </div>
      </div>
      <a href="/financeiro/extrato/?inicio=&fim=" class="text-sm underline">ver no extrato</a>
    </div>

    {% if vencidas_list %}
    <details class="mt-3">
      <summary class="cursor-pointer text-sm underline">ver detalhes</summary>
      <ul class="mt-3 divide-y divide-red-100 bg-white rounded-xl overflow-hidden border border-red-100">
        {% for p in vencidas_list %}
          <li class="px-3 py-2 flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium">
                <a href="{% url 'vendas:venda_detail' p.venda_id %}" class="hover:underline">
                  Venda #{{ p.venda_id }}
                </a>
                <span class="text-xs ml-2 px-2 py-0.5 rounded-full bg-red-100 text-red-800 font-semibold">
                  {{ p.numero }}/{{ p.venda.parcelas_total }}
                </span>
              </div>
              <div class="text-xs text-gray-500 truncate">
                {{ p.venda.cliente.nome }}
              </div>
            </div>
            <div class="shrink-0 text-right">
              <div class="font-semibold text-red-700">{{ p.valor|brl }}</div>
              <div class="text-xs text-gray-500">{{ p.vencimento|date:"d/m/Y" }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    </details>
    {% endif %}
  </div>
  {% endif %}

  {# ---- VENCEM HOJE ---- #}
  {% if vencem_hoje_count %}
  <div class="bg-blue-50 border border-blue-200 text-blue-900 p-4 rounded-2xl">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="font-semibold">üóìÔ∏è Vencem HOJE</div>
        <div class="text-sm mt-1">
          {{ vencem_hoje_count }} parcela(s) ‚Äî total {{ total_vencem_hoje|brl }}
        </div>
      </div>

      <a
        href="{% url 'financeiro:extrato' %}?inicio={{ hoje|date:'Y-m-d' }}&fim={{ hoje|date:'Y-m-d' }}#vencendo-hoje"
        class="text-sm underline shrink-0"
      >
        ver no extrato
      </a>
    </div>

    <details class="mt-3">
      <summary class="cursor-pointer text-sm underline">ver detalhes</summary>
      <ul class="mt-3 divide-y divide-blue-100 bg-white rounded-xl overflow-hidden border border-blue-100">
        {% for p in vencem_hoje %}
          <li class="px-3 py-2 flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium">
                <a href="{% url 'vendas:venda_detail' p.venda_id %}" class="hover:underline">
                  Venda #{{ p.venda_id }}
                </a>
                <span class="text-xs ml-2 px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 font-semibold">
                  {{ p.numero }}/{{ p.venda.parcelas_total }}
                </span>
              </div>
              <div class="text-xs text-gray-500 truncate">
                {{ p.venda.cliente.nome }}
              </div>
            </div>
            <div class="shrink-0 text-right">
              <div class="font-semibold text-blue-700">{{ p.valor|brl }}</div>
              <div class="text-xs text-gray-500">{{ p.vencimento|date:"d/m/Y" }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    </details>
  </div>
  {% endif %}

  {# ---- VENCEM EM 7 DIAS ---- #}
  {% if prox7_qtd %}
  <div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-2xl">
    <div class="flex items-center justify-between">
      <div>
        <div class="font-semibold">‚è≥ Vencem em 7 dias</div>
        <div class="text-sm text-amber-700 mt-1">
          {{ prox7_qtd }} parcela(s) ‚Äî total {{ prox7_valor|brl }}
        </div>
      </div>
      <a href="/financeiro/extrato/?inicio=&fim=" class="text-sm underline">ver no extrato</a>
    </div>

    {% if prox7_list %}
    <details class="mt-3">
      <summary class="cursor-pointer text-sm underline">ver detalhes</summary>
      <ul class="mt-3 divide-y divide-amber-100 bg-white rounded-xl overflow-hidden border border-amber-100">
        {% for p in prox7_list %}
          <li class="px-3 py-2 flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium">
                <a href="{% url 'vendas:venda_detail' p.venda_id %}" class="hover:underline">
                  Venda #{{ p.venda_id }}
                </a>
                <span class="text-xs ml-2 px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold">
                  {{ p.numero }}/{{ p.venda.parcelas_total }}
                </span>
              </div>
              <div class="text-xs text-gray-500 truncate">
                {{ p.venda.cliente.nome }}
              </div>
            </div>
            <div class="shrink-0 text-right">
              <div class="font-semibold text-amber-700">{{ p.valor|brl }}</div>
              <div class="text-xs text-gray-500">{{ p.vencimento|date:"d/m/Y" }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    </details>
    {% endif %}
  </div>
  {% endif %}

</div>
{% endif %}

{# ===================== KPIs DO PER√çODO ===================== #}
<div class="grid lg:grid-cols-3 gap-4 mb-8">
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">√Ä receber ({{ inicio|date:'d/m/Y' }}‚Äì{{ fim|date:'d/m/Y' }})</div>
    <div class="text-3xl font-bold">{{ a_receber|brl }}</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Vencidas (at√© hoje)</div>
    <div class="text-3xl font-bold">{{ vencidas|brl }}</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Pagas no per√≠odo</div>
    <div class="text-3xl font-bold">{{ pagas|brl }}</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Entradas l√≠quidas (vendas)</div>
    <div class="text-3xl font-bold">{{ entradas_liquidas|brl }}</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Despesas PAGAS no per√≠odo</div>
    <div class="text-3xl font-bold">{{ despesas_pagas|brl }}</div>
    <div class="text-xs text-gray-500 mt-1">Previstas: {{ despesas_previstas|brl }}</div>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="text-gray-500 text-sm">Fluxo l√≠quido do per√≠odo</div>
    <div class="text-3xl font-bold">{{ fluxo_liquido|brl }}</div>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-6 mb-8">
  <div class="bg-white p-5 rounded-2xl shadow">
    <h3 class="font-semibold mb-3">‚úîÔ∏è Recebido vs ‚ùå Despesa (√∫ltimos 6 meses)</h3>
    <canvas id="barChart"></canvas>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <h3 class="font-semibold mb-3">üìà Fluxo L√≠quido (√∫ltimos 6 meses)</h3>
    <canvas id="lineChart"></canvas>
  </div>
</div>

<h2 class="text-xl font-semibold mb-3">√öltimas parcelas</h2>
<div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
  {% for p in ultimas_parcelas %}
    <div class="relative bg-white p-4 rounded-xl shadow flex flex-col justify-between {% if p.status == 'VENCIDO' %}ring-1 ring-red-200{% endif %}">
      <a href="{% url 'vendas:venda_detail' p.venda_id %}" class="absolute inset-0" aria-label="Abrir venda {{ p.venda_id }}"></a>

      <div class="flex justify-between items-center mb-2 relative">
        <span class="text-sm text-gray-600">Venda {{ p.venda_id }}</span>
        <span class="px-2 py-0.5 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">
          {{ p.numero }}/{{ p.venda.parcelas_total }}
        </span>
      </div>

      <div class="text-sm font-medium truncate mb-2 relative" title="{{ p.venda.cliente.nome }}">
        {{ p.venda.cliente.nome }}
      </div>

      <div class="text-gray-500 text-sm mb-1 relative">
        Venc: {{ p.vencimento|date:'d/m/Y' }}
        {% if p.status == 'VENCIDO' %}
          <span class="ml-2 inline-flex items-center text-red-700 text-xs">‚óè em atraso</span>
        {% endif %}
      </div>

      {% if p.status == 'PAGO' and p.data_pagamento %}
        <div class="text-xs text-emerald-700 mb-1 relative">
          Pago em {{ p.data_pagamento|date:'d/m/Y' }}
        </div>
      {% endif %}

      <div class="text-lg font-bold mb-3 relative">{{ p.valor|brl }}</div>

      <div class="relative">
        {% if user.is_staff and p.status == 'PENDENTE' %}
          <form action="{% url 'vendas:parcela_pagar' p.id %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="w-full px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 relative z-10">
              Marcar como Pago
            </button>
          </form>
        {% elif user.is_staff and p.status == 'PAGO' %}
          <form action="{% url 'vendas:parcela_desfazer' p.id %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="w-full px-3 py-1 text-xs bg-amber-600 text-white rounded hover:bg-amber-700 relative z-10">
              Desfazer
            </button>
          </form>
        {% else %}
          <div class="mt-1 relative">{% badge_status p.status %}</div>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p class="col-span-full text-gray-500">Nenhum registro no per√≠odo.</p>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels|safe }};
  const recebido = {{ recebido_series|safe }};
  const gasto = {{ gasto_series|safe }};
  const fluxo = {{ fluxo_series|safe }};

  const COLORS = {
    green: 'rgba(16, 185, 129, 0.85)',
    red: 'rgba(239, 68, 68, 0.85)',
    blue: 'rgba(59, 130, 246, 1)',
    blueFill: 'rgba(59, 130, 246, 0.2)'
  };

  new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: '‚úîÔ∏è Recebido', data: recebido, backgroundColor: COLORS.green },
        { label: '‚ùå Despesa', data: gasto, backgroundColor: COLORS.red }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
  });

  new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'üìà Fluxo L√≠quido',
        data: fluxo,
        borderColor: COLORS.blue,
        backgroundColor: COLORS.blueFill,
        fill: true,
        tension: 0.35
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
  });
</script>

{% endblock %}